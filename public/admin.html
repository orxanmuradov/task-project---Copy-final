<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { padding: 20px; color: white; background: #121212; display: block; }
        .admin-container { max-width: 800px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        h1, h2 { color: #ffcc00; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #444; padding: 12px; text-align: left; }
        th { background: #333; color: #ffcc00; }
        
        /* D√ºym…ôl…ôr */
        .btn-action { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-delete { background: #ff4d4d; color: white; }
        .btn-delete:hover { background: #cc0000; }
        
        .btn-make-admin { background: #00e676; color: black; } /* Ya≈üƒ±l */
        .btn-make-user { background: orange; color: black; }    /* Narƒ±ncƒ± */

        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { background: #333; color: white; padding: 10px 20px; border: 1px solid #555; border-radius: 5px; text-decoration: none; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header-actions">
            <h1>üõ°Ô∏è Admin ƒ∞dar…ôetm…ô</h1>
            <div>
                <a href="/" class="back-btn">Ana S…ôhif…ô</a>
                <button id="logout-btn" class="back-btn" style="border-color:red; color:red;">√áƒ±xƒ±≈ü</button>
            </div>
        </div>

        <h2>üë• ƒ∞stifad…ô√ßil…ôr v…ô Rollar</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ad</th>
                        <th>Hazƒ±rkƒ± Rol</th>
                        <th>∆èm…ôliyyatlar</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");

        // Admin yoxlanƒ±≈üƒ±
        if (!token || role !== "admin") {
            alert("Siz Admin deyilsiniz!");
            window.location.href = "/";
        }

        document.getElementById("logout-btn").addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "/login";
        });

        async function loadUsers() {
            try {
                const res = await fetch("/api/admin/users", { headers: { "Authorization": `Bearer ${token}` } });
                if(!res.ok) throw new Error("ƒ∞caz…ô yoxdur");
                
                const data = await res.json();
                const tbody = document.getElementById("users-table-body");
                tbody.innerHTML = "";

                data.users.forEach(u => {
                    // Rol d…ôyi≈üm…ô d√ºym…ôsini t…ôyin ed…ôk
                    let roleBtn = "";
                    if (u.role === 'user') {
                        roleBtn = `<button onclick="changeRole(${u.id}, 'admin')" class="btn-action btn-make-admin">‚¨ÜÔ∏è Admin Et</button>`;
                    } else {
                        roleBtn = `<button onclick="changeRole(${u.id}, 'user')" class="btn-action btn-make-user">‚¨áÔ∏è User Et</button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td><span style="font-weight:bold; color:${u.role==='admin'?'#ffcc00':'#ccc'}">${u.role.toUpperCase()}</span></td>
                            <td>
                                ${roleBtn}
                                <button onclick="deleteUser(${u.id})" class="btn-action btn-delete">Sil</button>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error(error);
                alert("M…ôlumat y√ºkl…ônm…ôdi.");
            }
        }

        // --- ROL D∆èYƒ∞≈ûDƒ∞RM∆èK ---
        window.changeRole = async (id, newRole) => {
            if(!confirm(`Bu istifad…ô√ßini '${newRole.toUpperCase()}' etm…ôk ist…ôyirs…ôn?`)) return;

            const res = await fetch(`/api/admin/users/${id}/role`, {
                method: "PUT",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ role: newRole })
            });

            if(res.ok) {
                alert("Rol d…ôyi≈üdirildi!");
                loadUsers(); // C…ôdv…ôli yenil…ô
            } else {
                alert("X…ôta ba≈ü verdi");
            }
        };

        // --- ƒ∞STƒ∞FAD∆è√áƒ∞ Sƒ∞LM∆èK ---
        window.deleteUser = async (id) => {
            if(!confirm("ƒ∞stifad…ô√ßini h…ômi≈ü…ôlik silm…ôk ist…ôyirs…ôn?")) return;
            const res = await fetch(`/api/admin/users/${id}`, { method: "DELETE", headers: { "Authorization": `Bearer ${token}` } });
            if(res.ok) loadUsers();
        };

        loadUsers();
    </script>
</body>
</html>